name: ðŸš€ Build All Platforms

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-all:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: android
            os: ubuntu-latest
          - platform: web
            os: ubuntu-latest
          - platform: windows
            os: windows-latest
          - platform: linux
            os: ubuntu-latest
          - platform: macos
            os: macos-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Java (Android only)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Install dependencies
        working-directory: ./flutter
        run: flutter pub get

      - name: ðŸ” Analyze code
        working-directory: ./flutter
        run: flutter analyze
        continue-on-error: true

      - name: ðŸ”‘ Setup Android signing (Android only)
        if: matrix.platform == 'android'
        working-directory: ./flutter/android
        run: |
          mkdir -p app
          echo "storeFile=${{ secrets.ANDROID_KEYSTORE_FILE }}" > app/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> app/key.properties
          echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" >> app/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> app/key.properties
        continue-on-error: true

      - name: ðŸ“¥ Download keystore (Android only)
        if: matrix.platform == 'android' && secrets.ANDROID_KEYSTORE_BASE64 != ''
        working-directory: ./flutter/android/app
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > upload-keystore.jks
        continue-on-error: true

      - name: ðŸ—ï¸ Build Android APK
        if: matrix.platform == 'android'
        working-directory: ./flutter
        run: flutter build apk --release --split-per-abi
        continue-on-error: true

      - name: ðŸ—ï¸ Build Android AAB
        if: matrix.platform == 'android'
        working-directory: ./flutter
        run: flutter build appbundle --release
        continue-on-error: true

      - name: ðŸ—ï¸ Build Web
        if: matrix.platform == 'web'
        working-directory: ./flutter
        run: |
          flutter config --enable-web
          flutter build web --release
        continue-on-error: true

      - name: ðŸ—ï¸ Build Windows
        if: matrix.platform == 'windows'
        working-directory: ./flutter
        run: |
          flutter config --enable-windows-desktop
          flutter build windows --release
        continue-on-error: true

      - name: ðŸ—ï¸ Build Linux
        if: matrix.platform == 'linux'
        working-directory: ./flutter
        run: |
          flutter config --enable-linux-desktop
          flutter build linux --release
        continue-on-error: true

      - name: ðŸ—ï¸ Build macOS
        if: matrix.platform == 'macos'
        working-directory: ./flutter
        run: |
          flutter config --enable-macos-desktop
          flutter build macos --release
        continue-on-error: true

      - name: ðŸ“¤ Upload Android APK
        if: matrix.platform == 'android'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.run_number }}
          path: flutter/build/app/outputs/flutter-apk/*.apk
          retention-days: 90

      - name: ðŸ“¤ Upload Android AAB
        if: matrix.platform == 'android'
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-${{ github.run_number }}
          path: flutter/build/app/outputs/bundle/release/*.aab
          retention-days: 90

      - name: ðŸ“¤ Upload Web
        if: matrix.platform == 'web'
        uses: actions/upload-artifact@v4
        with:
          name: web-release-${{ github.run_number }}
          path: flutter/build/web/**
          retention-days: 90

      - name: ðŸ“¤ Upload Windows
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-${{ github.run_number }}
          path: flutter/build/windows/x64/runner/Release/**
          retention-days: 90

      - name: ðŸ“¤ Upload Linux
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-release-${{ github.run_number }}
          path: flutter/build/linux/x64/release/bundle/**
          retention-days: 90

      - name: ðŸ“¤ Upload macOS
        if: matrix.platform == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: macos-release-${{ github.run_number }}
          path: flutter/build/macos/Build/Products/Release/**
          retention-days: 90

      - name: ðŸ“Š Build summary
        if: always()
        run: |
          echo "## ðŸš€ Build ${{ matrix.platform }} Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build ${{ matrix.platform }} terminÃ© !" >> $GITHUB_STEP_SUMMARY

